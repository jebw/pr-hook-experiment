name: Deploy PR
on: [ issue_comment ]
env:
  TRIGGER_KEYWORD: DEPLOY
jobs:
  check_comment:
    name: Check comment
    runs-on: ubuntu-20.04
    steps:
      - name: Check comment
        run: |-
          echo ISSUE COMMENTED AT $(date)

      - name: Event action check
        id: eventcheck
        run: |-
          EVENT_ACTION=$(jq -r .action $GITHUB_EVENT_PATH)

          if [ "x$EVENT_ACTION" = "xcreated" ]; then
            echo ::set-output name=created::true
          fi

      - name: Check for keyword
        if: steps.eventcheck.outputs.created
        id: keyword
        run: |-
          COMMENT=$(jq -r .comment.body $GITHUB_EVENT_PATH)

          if [ "x$COMMENT" = "x$TRIGGER_KEYWORD" ]; then
            echo ::set-output name=match::true
          fi

      - name: Branch and sha
        if: steps.keyword.outputs.match
        run: |-
          echo "GIT REF $GITHUB_REF"
          echo "GIT SHA $GITHUB_SHA"

      - name: Extract comments URL
        id: commentsurl
        if: steps.keyword.outputs.match
        run: |-
          COMMENTS_URL=$(jq -r .issue.comments_url $GITHUB_EVENT_PATH)

          curl -X POST \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            $COMMENTS_URL --data '{"body": "Released at $(date)"}'

